{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "NuoDB doployed on EC2 Instances",
  "Mappings" : {
    "ARNNamespace": {
      "us-east-1":      { "Partition": "aws" },
      "us-east-2":      { "Partition": "aws" },
      "us-west-2":      { "Partition": "aws" },
      "us-west-1":      { "Partition": "aws" },
      "eu-west-1":      { "Partition": "aws" },
      "eu-central-1":   { "Partition": "aws" },
      "ap-southeast-1": { "Partition": "aws" },
      "ap-northeast-1": { "Partition": "aws" },
      "ap-southeast-2": { "Partition": "aws" },
      "sa-east-1":      { "Partition": "aws" },
      "us-gov-west-1":  { "Partition": "aws-us-gov" }
    },
    "S3Region": { "us-east-1": { "Region": "us-east-1" },
      "us-east-2": {
        "Region": "us-east-2"
      },
      "us-west-2": {
        "Region": "us-east-1"
      },
      "us-west-1": {
        "Region": "us-east-1"
      },
      "eu-west-1": {
        "Region": "us-east-1"
      },
      "eu-central-1": {
        "Region": "us-east-1"
      },
      "ap-southeast-1": {
        "Region": "us-east-1"
      },
      "ap-northeast-1": {
        "Region": "us-east-1"
      },
      "ap-southeast-2": {
        "Region": "us-east-1"
      },
      "sa-east-1": {
        "Region": "us-east-1"
      },
      "us-gov-west-1": {
        "Region": "us-gov-west-1"
      }
    }
  },

  "Parameters": {
    "Bucket" : {
      "Type" : "String"
    },

    "EcsClusterName" : {
      "Type" : "String"
    },

    "nuodbDocker" : {
      "Type" : "String"
    },

    "VolumeSize" : {
      "Type" : "Number"
    },

    "brokerELB" : {
      "Type" : "String"
    },

    "StorefrontElb" : {
      "Type" : "String"
    },

    "peerAddress" : {
      "Type" : "String"
    },

    "dbuser" : {
      "Type": "String"
    },

    "dbpassword" : {
      "Type": "String"
    },

    "dbname" : {
      "Type": "String"
    },

    "DomainPassword" : {
      "Type": "String"
    },

    "EnvironmentType" : {
      "Type" : "String"
    },

    "NuoDBInstanceAMI" : {
      "Type" : "String"
    },

    "NuoDBInstanceType" : {
      "Type" : "String"
    },

    "SMStorageSize" : {
      "Type" : "Number"
    },

    "SMStorageType" : {
      "Type" : "String"
    },

    "KeyName" : {
      "Type" : "String"
    },

    "VpcId" : {
      "Type" : "String"
    },

    "SubnetIds" : {
      "Type" : "CommaDelimitedList"
    },

    "Az1" : {
      "Type" : "String"
    },
    "BrokerElbSecurityGroup" : {
      "Type" : "String"
    },

    "CWLogGroup" : {
      "Type" : "String"
    },
    "ElkPrivateIP" : {
      "Type" : "String"
    },
    "ElasticPort" : {
      "Type" : "String",
      "Default" : "9200"
    },
    "ElasticIndex" : {
      "Type" : "String",
      "Default" : "interactive-demo"
    }
  },

  "Resources" : {
    "EC2InstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement":
          [
            {
              "Effect": "Allow",
              "Principal" : { "Service": [ "ec2.amazonaws.com", "ecs-tasks.amazonaws.com" ] },
              "Action": [ "sts:AssumeRole" ]
            }
          ]
        },
        "Path": "/",
        "Policies":
        [
          {
            "PolicyName": "deployRead",
            "PolicyDocument": {
              "Statement":
              [
                {
                  "Action": [ "s3:Get*", "s3:List*" ],
                  "Effect": "Allow",
                  "Resource":
                  [
                    { "Fn::Join": [ "", [ "arn:", { "Fn::FindInMap" : [ "ARNNamespace", { "Ref" : "AWS::Region" },  "Partition" ] }, ":s3:::", {"Ref" : "Bucket"}, "/"]]},
                    { "Fn::Join": [ "", [ "arn:", { "Fn::FindInMap" : [ "ARNNamespace", { "Ref" : "AWS::Region" },  "Partition" ] }, ":s3:::", {"Ref" : "Bucket"}, "/*"]]}
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": "deployBucketRead",
            "PolicyDocument": {
              "Statement":
              [
                {
                  "Action": [  "s3:List*" ],
                  "Effect": "Allow",
                  "Resource":
                  [
                    { "Fn::Join": [ "", [ "arn:", { "Fn::FindInMap" : [ "ARNNamespace", { "Ref" : "AWS::Region" },  "Partition" ] }, ":s3:::", {"Ref" : "Bucket"}]]}
                  ]
                }
              ]
            }
          },

          {
            "PolicyName": "cloudwatchLogs",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:GetLogEvents",
                    "logs:PutLogEvents",
                    "logs:DescribeLogGroups",
                    "logs:DescribeLogStreams"
                  ],
                  "Resource": [
                    { "Fn::Join": [ "", [ "arn:", { "Fn::FindInMap" : [ "ARNNamespace", { "Ref" : "AWS::Region" },  "Partition" ] }, ":logs:*:*:*" ]]}
                  ]
                }
              ]
            }
          },
          {
            "PolicyName" : "ECSCreateCluster",
            "PolicyDocument" : {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "*"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "PolicyName": "createandattachvolume",
            "PolicyDocument":  {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "Stmt1441831086000",
                  "Effect": "Allow",
                  "Action": [
                    "ec2:AttachVolume",
                    "ec2:CreateVolume",
                    "ec2:DescribeVolumes",
                    "ec2:CreateSnapshot",
                    "ec2:DeleteSnapshot",
                    "ec2:DescribeSnapshots",
                    "ec2:CreateTags",
                    "ec2:ModifyInstanceAttribute"
                  ],
                  "Resource": [ "*" ]
                }
              ]
            }
          },
          {
            "PolicyName": "manageElb",
            "PolicyDocument":  {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "Stmt1441831086000",
                  "Effect": "Allow",
                  "Action": [
                    "elasticloadbalancing:*"
                  ],
                  "Resource": [ "*" ]
                }
              ]
            }
          }
        ]
      }
    },

    "EC2InstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [ { "Ref": "EC2InstanceRole" } ]
      }
    },


    "NuoDBSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Allow access to NuoDB ports",
        "VpcId" : { "Ref" : "VpcId" },
        "SecurityGroupIngress" :
        [
          { "IpProtocol" : "tcp", "FromPort" : "48004", "ToPort" : "48004", "SourceSecurityGroupId" :  { "Ref" : "BrokerElbSecurityGroup" } },
          { "IpProtocol" : "tcp", "FromPort" : "8888", "ToPort" : "8888", "SourceSecurityGroupId" :  { "Ref" : "BrokerElbSecurityGroup" } },
          { "IpProtocol" : "tcp", "FromPort" : "48010", "ToPort" : "48010",  "CidrIp": "10.0.0.0/16" },
          { "IpProtocol" : "tcp", "FromPort" : "48004", "ToPort" : "48005",  "CidrIp": "10.0.0.0/16" },
          { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp": "0.0.0.0/0" }
        ]
      }
    },

    "NuoDBBrokerLaunchConfig": {
      "Type" : "AWS::AutoScaling::LaunchConfiguration",
      "Metadata" :
      {
        "AWS::CloudFormation::Init" : {

          "configSets" : {
            "deploy_by_ansible"    : [
              "setup_cloud_env",
              "setup_cloudwatch_logs",
              "install_cfn_hup",
              "setup_static_ip"
            ]
          },

          "setup_cloud_env" : {
            "files" : {
              "/local/etc/cloud-env.sh" :  {
                "content" : { "Fn::Join" : ["", [
                  "export NODE_REGION='",     { "Ref" : "AWS::Region" },  "'\n",
                  "export S3_Region='", { "Fn::FindInMap" : [ "S3Region", { "Ref" : "AWS::Region" },  "Region" ] },  "'\n",
                  "export CFN_StackId='",    { "Ref" : "AWS::StackId" }, "'\n",
                  "export DOMAIN_PASSWORD='", { "Ref": "DomainPassword" }, "'\n",
                  "export ENV_TYPE='", { "Ref": "EnvironmentType" }, "'\n",
                  "export AGENT_PORT=48004\n",
                  "export BROKER_PORT=48004\n",
                  "export NODE_PORT=48010\n",
                  "export NODE_TYPE='BROKER'\n",
                  "export PEER_ADDRESS='", { "Ref" : "peerAddress" }, "'\n",
                  "export DB_NAME='", { "Ref": "dbname" }, "'\n",
                  "export DB_USER='", { "Ref": "dbuser" }, "'\n",
                  "export DB_PASSWORD='", { "Ref": "dbpassword" }, "'\n",
                  "export ARG_apphost='", { "Fn::Join" : ["", ["http://", { "Ref" : "StorefrontElb" }, ":80/StorefrontWeb" ]]}, "'\n",
                  "export EcsClusterName='", { "Ref" : "EcsClusterName" }, "'\n",
                  "export NUODB_DOCKER='", { "Ref": "nuodbDocker" }, "'\n",
                  "export ELASTIC_HOST='", { "Ref" : "ElkPrivateIP"}, "'\n",
                  "export ELASTIC_PORT='", { "Ref" : "ElasticPort"}, "'\n",
                  "export ELASTIC_INDEX='", { "Ref" : "ElasticIndex"}, "'\n"

                ]]},
                "mode" : "000400",
                "owner" : "root",
                "group" : "root"
              }
            }
          },

          "setup_cloudwatch_logs" : {

            "files" : {
              "/etc/awslogs/awslogs.conf": {
                "content": { "Fn::Join": [ "", [
                  "[general]\n",
                  "state_file= /var/lib/awslogs/agent-state\n\n",

                  "[/var/log/messages]\n",
                  "file = /var/log/messages\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/messages\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/cloud-init]\n",
                  "file = /var/log/cloud-init.*\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/cloud-init.log\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/cloud-init-output]\n",
                  "file = /var/log/cloud-init-output.*\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/cloud-init-output.log\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/cfn-init]\n",
                  "file = /var/log/cfn-init.log*\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/cfn-init.log\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/cfn-init-cmd]\n",
                  "file = /var/log/cfn-init-cmd.log*\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/cfn-init-cmd.log\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/docker]\n",
                  "file = /var/log/docker\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb-docker/{instance_id}/docker-daemon\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/docker-logs-output]\n",
                  "file = /var/log/docker-logs-output\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb-docker/{instance_id}/docker-logs-output\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n"

                ]]},
                "mode": "000400",
                "owner": "root",
                "group": "root"
              },
              "/etc/awslogs/awscli.conf": {
                "content": { "Fn::Join": [ "", [
                  "[plugins]\ncwlogs = cwlogs\n[default]\nregion = ", { "Ref" : "AWS::Region" }, "\n"
                ]]},
                "mode": "000400",
                "owner": "root",
                "group": "root"
              }
            },

            "packages" : {  "yum" : { "awslogs" : [] } },

            "services" : {
              "sysvinit" : {
                "awslogs" : {
                  "enabled" : "true",
                  "ensureRunning" : "true",
                  "files" : ["/etc/awslogs/awslogs.conf"]
                }
              }
            }
          },

          "install_cfn_hup" : {

            "files" : {
              "/etc/cfn/cfn-hup.conf" : {
                "content" : { "Fn::Join" : ["", [
                  "[main]\n",
                  "stack=", { "Ref" : "AWS::StackId" }, "\n",
                  "region=", { "Ref" : "AWS::Region" }, "\n",
                  "verbose=true\n",
                  "interval=5\n"
                ]]},
                "mode"    : "000400",
                "owner"   : "root",
                "group"   : "root"
              },

              "/etc/cfn/hooks.d/cfn-auto-reloader.conf" : {
                "content": { "Fn::Join" : ["", [
                  "[cfn-auto-reloader-hook]\n",
                  "triggers=post.update\n",
                  "path=Resources.NuoDBBrokerLaunchConfig.Metadata.AWS::CloudFormation::Init\n",
                  "action=/opt/aws/bin/cfn-init -v ",
                  "         --stack ", { "Ref" : "AWS::StackName" },
                  "         --resource NuoDBBrokerLaunchConfig ",
                  "         --configsets deploy_by_ansible ",
                  "         --region ", { "Ref" : "AWS::Region" }, "\n",
                  "runas=root\n"
                ]]}
              }
            },

            "services" : {
              "sysvinit" : {
                "cfn-hup" : {
                  "enabled" : "true",
                  "ensureRunning" : "true",
                  "files" : ["/etc/cfn/cfn-hup.conf", "/etc/cfn/hooks.d/cfn-auto-reloader.conf"]
                }
              }
            }
          },

          "setup_static_ip" : {
            "packages" : {
              "python": { "aws-ec2-assign-elastic-ip": [ "0.5.0" ] }
            },
            "commands" : {
              "01_assign_ip" : {
                "command" : "source /local/etc/cloud-env.sh && if [ ! -z $Whitelist_EIPS ]; then /usr/local/bin/aws-ec2-assign-elastic-ip --valid-ips ${Whitelist_EIPS} --region ${CFN_Region}; fi"
              }
            }
          }
        }
      },
      "Properties" : {
        "KeyName" : { "Ref" : "KeyName" },
        "AssociatePublicIpAddress" : "true",
        "ImageId" : { "Ref" : "NuoDBInstanceAMI" },
        "InstanceType"   : { "Ref" : "NuoDBInstanceType" },
        "IamInstanceProfile" : {"Ref": "EC2InstanceProfile" },
        "SecurityGroups" : [
          {"Ref" : "NuoDBSecurityGroup" }],
        "UserData" : { "Fn::Base64" : { "Fn::Join" : [ "", [
          "#!/bin/bash -v\n",
          "yum update -y aws-cfn-bootstrap\n",

          "export CFN_StackId=",     { "Ref" : "AWS::StackId" }, "\n",
          "export CFN_StackName=",   { "Ref" : "AWS::StackName" }, "\n",
          "export CFN_Region=",      { "Ref" : "AWS::Region"  }, "\n",
          "export NODE_REGION='",     { "Ref" : "AWS::Region" },  "'\n",
          "export S3_Region='", { "Fn::FindInMap" : [ "S3Region", { "Ref" : "AWS::Region" },  "Region" ] },  "'\n",

          "export DOMAIN_PASSWORD='", { "Ref": "DomainPassword" }, "'\n",
          "export ENV_TYPE='", { "Ref": "EnvironmentType" }, "'\n",
          "export AGENT_PORT=48004\n",
          "export BROKER_PORT=48004\n",
          "export NODE_PORT=48010\n",
          "export NODE_TYPE='BROKER'\n",
          "export PEER_ADDRESS='", { "Ref" : "peerAddress" }, "'\n",
          "export DB_NAME='", { "Ref": "dbname" }, "'\n",
          "export DB_USER='", { "Ref": "dbuser" }, "'\n",
          "export DB_PASSWORD='", { "Ref": "dbpassword" }, "'\n",
          "export ARG_apphost='", { "Fn::Join" : ["", ["http://", { "Ref" : "StorefrontElb" }, ":80/StorefrontWeb" ]]}, "'\n",
          "export EcsClusterName='", { "Ref" : "EcsClusterName" }, "'\n",
          "export NUODB_DOCKER='", { "Ref": "nuodbDocker" }, "'\n",
          "export INSTANCE_ID=$( /opt/aws/bin/ec2-metadata -i | cut -d ' ' -f 2 )\n",
          "export AZ=$( /opt/aws/bin/ec2-metadata -z | cut -d ' ' -f 2 )\n",
          "export ELASTIC_HOST='", { "Ref" : "ElkPrivateIP"}, "'\n",
          "export ELASTIC_PORT='", { "Ref" : "ElasticPort"}, "'\n",
          "export ELASTIC_INDEX='", { "Ref" : "ElasticIndex"}, "'\n",

          "VOL_ID=$( aws ec2 create-volume ",
          "  --region ${CFN_Region} --availability-zone ${AZ} ",
          "  --volume-type gp2 --size ", { "Ref" : "VolumeSize" }, " ${ENC_ARGS} ",
          " | grep VolumeId | cut -d \\\" -f 4 )\n",

          "aws ec2 create-tags --region ${CFN_Region}  --resources ${VOL_ID} --tags Key=Name,Value='",
          { "Fn::Join" : [ " - ", [ { "Ref": "AWS::StackName" }, "NuoDB Volume" ] ] } ,"'\n",

          "aws ec2 create-tags --region ${CFN_Region}  --resources ${VOL_ID} --tags Key=CustomerID,Value='",{ "Ref": "EcsClusterName" },"'\n",

          "sleep 10\n",
          "while ! [ \"available\" = $(aws ec2 describe-volumes --region ${CFN_Region} --volume-ids ${VOL_ID} --query Volumes[0].State | tr \\\" ' ' ) ]; do\n",
          "   sleep 1;\n",
          "done\n",

          "aws ec2 attach-volume --region ${CFN_Region}  ",
          "  --volume-id ${VOL_ID} --instance-id ${INSTANCE_ID} ",
          "  --device /dev/xvdf \n",

          "aws ec2 modify-instance-attribute --region ${CFN_Region} ",
          "  --instance-id $INSTANCE_ID --block-device-mappings ",
          "  '[{\"DeviceName\":\"/dev/xvdf\",\"Ebs\": {\"DeleteOnTermination\":true} }]'\n",

          "while ! [ -r /dev/xvdf ]; do sleep 1; done\n",
          "/sbin/mkfs.ext4 /dev/xvdf && mount /dev/xvdf /local\n",

          "aws ec2 describe-volumes --region ${CFN_Region} --volume-ids ${VOL_ID} \n",

          "mkdir -p /local/log\n",

          "yum install docker -y\n",

          "service docker restart\n",

          "cmd='$(aws ecr get-login --region us-east-1)' && eval $cmd && docker pull ${NUODB_DOCKER} \n",

          "docker run -d -e \"DOMAIN_PASSWORD=${DOMAIN_PASSWORD}\" ",
          "   -e \"AGENT_PORT=${AGENT_PORT}\" ",
          "   -e \"NODE_TYPE=${NODE_TYPE}\" ",
          "   -e \"ENV_TYPE=AWSEC2\" ",
          "   -e \"DB_NAME=${DB_NAME}\" ",
          "   -e \"DB_USER=${DB_USER}\" ",
          "   -e \"DB_PASSWORD=${DB_PASSWORD}\" ",
          "   -e \"BROKER_PORT=${BROKER_PORT}\" ",
          "   -e \"DOMAIN_PASSWORD=${DOMAIN_PASSWORD}\" ",
          "   -e \"PEER_ADDRESS=${PEER_ADDRESS}\" ",
          "   -e \"NODE_REGION=${NODE_REGION}\" ",
          "   -e \"ARG_apphost=${ARG_apphost}\" ",
          "   -e \"ELASTIC_HOST=${ELASTIC_HOST}\" ",
          "   -e \"ELASTIC_PORT=${ELASTIC_PORT}\" ",
          "   -e \"ELASTIC_INDEX=${ELASTIC_INDEX}\" ",
          "   -p 48004:48004 ",
          "   -p 8888:8888 ${NUODB_DOCKER} \n",


          "/opt/aws/bin/cfn-init ",
          "   --stack ${CFN_StackId} ",
          "   --resource NuoDBBrokerLaunchConfig ",
          "   --region ${CFN_Region} ",
          "   --configsets deploy_by_ansible\n",

          "# Signal results.\n",
          "/opt/aws/bin/cfn-signal -e $? ",
          "  --region ${CFN_Region} ",
          "  --stack \"${CFN_StackName}\" ",
          "  --resource NuoDBBrokerASG ",
          "  --reason \"CFN config setup exited with value $?.\" \n"
        ]]}}
      }
    },

    "NuoDBBrokerASG" : {
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "CreationPolicy": { "ResourceSignal": { "Count" : "1", "Timeout": "PT45M" } },
      "UpdatePolicy" : {
        "AutoScalingRollingUpdate" : {
          "MinInstancesInService" : "1",
          "MaxBatchSize" : "1",
          "WaitOnResourceSignals" : "true",
          "SuspendProcesses" : [ "AlarmNotification" ],
          "PauseTime" : "PT45M"
        }
      },
      "Properties" : {
        "AvailabilityZones" : [ { "Fn::Select" : [ "0", { "Fn::GetAZs" : { "Ref" : "AWS::Region" } } ] } ],
        "VPCZoneIdentifier" : [ { "Fn::Select" : [ "0", { "Ref" : "SubnetIds" }]} ],
        "LaunchConfigurationName" : { "Ref" : "NuoDBBrokerLaunchConfig" },
        "MinSize" : "1",
        "MaxSize" : "2",
        "DesiredCapacity" : "1",
        "HealthCheckGracePeriod" : "600",
        "HealthCheckType" : "ELB",
        "LoadBalancerNames" : [{ "Ref" : "brokerELB" }],
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Join" : [ " - ", [ { "Ref": "AWS::StackName" }, "NuoDBBroker" ]] },
            "PropagateAtLaunch" : "true"
          }
        ]
      }
    },

    "SMStorageVolume" : {
      "Type":"AWS::EC2::Volume",
      "Properties" : {
        "AvailabilityZone" : { "Ref" : "Az1" },
        "Size" : { "Ref" : "SMStorageSize"},
        "Tags" : [
          {
            "Key" : "Name",
            "Value" : { "Fn::Join" : [ "-", [ { "Ref" : "AWS::StackName"}, "SM-Storage-Volume"]]}
          }
        ],
        "VolumeType" : { "Ref" : "SMStorageType" }
      }
    },

    "NuoDBSMLaunchConfig": {
      "Type" : "AWS::AutoScaling::LaunchConfiguration",
      "Metadata" :
      {
        "AWS::CloudFormation::Init" : {

          "configSets" : {
            "deploy_by_ansible"    : [
              "setup_cloud_env",
              "setup_cloudwatch_logs",
              "install_cfn_hup",
              "setup_static_ip"
            ]
          },

          "setup_cloud_env" : {
            "files" : {
              "/local/etc/cloud-env.sh" :  {
                "content" : { "Fn::Join" : ["", [
                  "export NODE_REGION='",     { "Ref" : "AWS::Region" },  "'\n",
                  "export S3_Region='", { "Fn::FindInMap" : [ "S3Region", { "Ref" : "AWS::Region" },  "Region" ] },  "'\n",
                  "export CFN_StackId='",    { "Ref" : "AWS::StackId" }, "'\n",
                  "export DOMAIN_PASSWORD='", { "Ref": "DomainPassword" }, "'\n",
                  "export ENV_TYPE='", { "Ref": "EnvironmentType" }, "'\n",
                  "export AGENT_PORT=48004\n",
                  "export BROKER_PORT=48004\n",
                  "export NODE_PORT=48010\n",
                  "export NODE_TYPE='SM'\n",
                  "export PEER_ADDRESS='", { "Ref" : "peerAddress" }, "'\n",
                  "export DB_NAME='", { "Ref": "dbname" }, "'\n",
                  "export DB_USER='", { "Ref": "dbuser" }, "'\n",
                  "export DB_PASSWORD='", { "Ref": "dbpassword" }, "'\n",
                  "export ARG_apphost='", { "Fn::Join" : ["", ["http://", { "Ref" : "StorefrontElb" }, ":80/StorefrontWeb" ]]}, "'\n",
                  "export EcsClusterName='", { "Ref" : "EcsClusterName" }, "'\n",
                  "export NUODB_DOCKER='", { "Ref": "nuodbDocker" }, "'\n",
                  "export ELASTIC_HOST='", { "Ref" : "ElkPrivateIP"}, "'\n",
                  "export ELASTIC_PORT='", { "Ref" : "ElasticPort"}, "'\n",
                  "export ELASTIC_INDEX='", { "Ref" : "ElasticIndex"}, "'\n"

                ]]},
                "mode" : "000400",
                "owner" : "root",
                "group" : "root"
              }
            }
          },

          "setup_cloudwatch_logs" : {

            "files" : {
              "/etc/awslogs/awslogs.conf": {
                "content": { "Fn::Join": [ "", [
                  "[general]\n",
                  "state_file= /var/lib/awslogs/agent-state\n\n",

                  "[/var/log/messages]\n",
                  "file = /var/log/messages\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/messages\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/cloud-init]\n",
                  "file = /var/log/cloud-init.*\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/cloud-init.log\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/cloud-init-output]\n",
                  "file = /var/log/cloud-init-output.*\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/cloud-init-output.log\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/cfn-init]\n",
                  "file = /var/log/cfn-init.log*\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/cfn-init.log\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/cfn-init-cmd]\n",
                  "file = /var/log/cfn-init-cmd.log*\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/cfn-init-cmd.log\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/docker]\n",
                  "file = /var/log/docker\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb-docker/{instance_id}/docker-daemon\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/docker-logs-output]\n",
                  "file = /var/log/docker-logs-output\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb-docker/{instance_id}/docker-logs-output\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n"

                ]]},
                "mode": "000400",
                "owner": "root",
                "group": "root"
              },
              "/etc/awslogs/awscli.conf": {
                "content": { "Fn::Join": [ "", [
                  "[plugins]\ncwlogs = cwlogs\n[default]\nregion = ", { "Ref" : "AWS::Region" }, "\n"
                ]]},
                "mode": "000400",
                "owner": "root",
                "group": "root"
              }
            },

            "packages" : {  "yum" : { "awslogs" : [] } },

            "services" : {
              "sysvinit" : {
                "awslogs" : {
                  "enabled" : "true",
                  "ensureRunning" : "true",
                  "files" : ["/etc/awslogs/awslogs.conf"]
                }
              }
            }
          },

          "install_cfn_hup" : {

            "files" : {
              "/etc/cfn/cfn-hup.conf" : {
                "content" : { "Fn::Join" : ["", [
                  "[main]\n",
                  "stack=", { "Ref" : "AWS::StackId" }, "\n",
                  "region=", { "Ref" : "AWS::Region" }, "\n",
                  "verbose=true\n",
                  "interval=5\n"
                ]]},
                "mode"    : "000400",
                "owner"   : "root",
                "group"   : "root"
              },

              "/etc/cfn/hooks.d/cfn-auto-reloader.conf" : {
                "content": { "Fn::Join" : ["", [
                  "[cfn-auto-reloader-hook]\n",
                  "triggers=post.update\n",
                  "path=Resources.NuoDBSMLaunchConfig.Metadata.AWS::CloudFormation::Init\n",
                  "action=/opt/aws/bin/cfn-init -v ",
                  "         --stack ", { "Ref" : "AWS::StackName" },
                  "         --resource NuoDBSMLaunchConfig ",
                  "         --configsets deploy_by_ansible ",
                  "         --region ", { "Ref" : "AWS::Region" }, "\n",
                  "runas=root\n"
                ]]}
              }
            },

            "services" : {
              "sysvinit" : {
                "cfn-hup" : {
                  "enabled" : "true",
                  "ensureRunning" : "true",
                  "files" : ["/etc/cfn/cfn-hup.conf", "/etc/cfn/hooks.d/cfn-auto-reloader.conf"]
                }
              }
            }
          },

          "setup_static_ip" : {
            "packages" : {
              "python": { "aws-ec2-assign-elastic-ip": [ "0.5.0" ] }
            },
            "commands" : {
              "01_assign_ip" : {
                "command" : "source /local/etc/cloud-env.sh && if [ ! -z $Whitelist_EIPS ]; then /usr/local/bin/aws-ec2-assign-elastic-ip --valid-ips ${Whitelist_EIPS} --region ${CFN_Region}; fi"
              }
            }
          }
        }
      },
      "Properties" : {
        "KeyName" : { "Ref" : "KeyName" },
        "AssociatePublicIpAddress" : "true",
        "ImageId" : { "Ref" : "NuoDBInstanceAMI" },
        "InstanceType"   : { "Ref" : "NuoDBInstanceType" },
        "IamInstanceProfile" : {"Ref": "EC2InstanceProfile" },
        "SecurityGroups" : [
          {"Ref" : "NuoDBSecurityGroup" }],
        "UserData" : { "Fn::Base64" : { "Fn::Join" : [ "", [
          "#!/bin/bash -v\n",
          "yum update -y aws-cfn-bootstrap\n",

          "export CFN_StackId=",     { "Ref" : "AWS::StackId" }, "\n",
          "export CFN_StackName=",   { "Ref" : "AWS::StackName" }, "\n",
          "export CFN_Region=",      { "Ref" : "AWS::Region"  }, "\n",
          "export NODE_REGION='",     { "Ref" : "AWS::Region" },  "'\n",
          "export S3_Region='", { "Fn::FindInMap" : [ "S3Region", { "Ref" : "AWS::Region" },  "Region" ] },  "'\n",

          "export DOMAIN_PASSWORD='", { "Ref": "DomainPassword" }, "'\n",
          "export ENV_TYPE='", { "Ref": "EnvironmentType" }, "'\n",
          "export AGENT_PORT=48004\n",
          "export BROKER_PORT=48004\n",
          "export NODE_PORT=48010\n",
          "export NODE_TYPE='SM'\n",
          "export PEER_ADDRESS='", { "Ref" : "peerAddress" }, "'\n",
          "export DB_NAME='", { "Ref": "dbname" }, "'\n",
          "export DB_USER='", { "Ref": "dbuser" }, "'\n",
          "export DB_PASSWORD='", { "Ref": "dbpassword" }, "'\n",
          "export ARG_apphost='", { "Fn::Join" : ["", ["http://", { "Ref" : "StorefrontElb" }, ":80/StorefrontWeb" ]]}, "'\n",
          "export EcsClusterName='", { "Ref" : "EcsClusterName" }, "'\n",
          "export NUODB_DOCKER='", { "Ref": "nuodbDocker" }, "'\n",
          "export INSTANCE_ID=$( /opt/aws/bin/ec2-metadata -i | cut -d ' ' -f 2 )\n",
          "export AZ=$( /opt/aws/bin/ec2-metadata -z | cut -d ' ' -f 2 )\n",
          "export ELASTIC_HOST='", { "Ref" : "ElkPrivateIP"}, "'\n",
          "export ELASTIC_PORT='", { "Ref" : "ElasticPort"}, "'\n",
          "export ELASTIC_INDEX='", { "Ref" : "ElasticIndex"}, "'\n",
          "export POPULATE_NUODB=true\n",


          "sleep 10\n",
          "while ! [ \"available\" = $(aws ec2 describe-volumes --region ${CFN_Region} --volume-ids ", { "Ref" : "SMStorageVolume" }, " --query Volumes[0].State | tr \\\" ' ' ) ]; do\n",
          "   sleep 1;\n",
          "done\n",

          "aws ec2 attach-volume --region ${CFN_Region}  ",
          "  --volume-id ", { "Ref" : "SMStorageVolume" }, " --instance-id ${INSTANCE_ID} ",
          "  --device /dev/xvdf \n",

          "aws ec2 modify-instance-attribute --region ${CFN_Region} ",
          "  --instance-id $INSTANCE_ID --block-device-mappings ",
          "  '[{\"DeviceName\":\"/dev/xvdf\",\"Ebs\": {\"DeleteOnTermination\":false} }]'\n",

          "while ! [ -r /dev/xvdf ]; do sleep 1; done\n",
          "mount /dev/xvdf /local\n",

          "aws ec2 describe-volumes --region ${CFN_Region} --volume-ids ", { "Ref" : "SMStorageVolume" }, "\n",

          "mkdir -p /local/log\n",
          "mkdir -p /local/production-archives\n",
          "chown 1000:root /local/production-archives\n",

          "yum install docker -y\n",

          "service docker restart\n",

          "cmd='$(aws ecr get-login --region us-east-1)' && eval $cmd && docker pull ${NUODB_DOCKER} \n",

          "docker run -d -e \"DOMAIN_PASSWORD=${DOMAIN_PASSWORD}\" ",
          "   -e \"AGENT_PORT=${AGENT_PORT}\" ",
          "   -e \"NODE_PORT=48010\" ",
          "   -e \"NODE_TYPE=${NODE_TYPE}\" ",
          "   -e \"ENV_TYPE=AWSEC2\" ",
          "   -e \"DB_NAME=${DB_NAME}\" ",
          "   -e \"DB_USER=${DB_USER}\" ",
          "   -e \"DB_PASSWORD=${DB_PASSWORD}\" ",
          "   -e \"BROKER_PORT=${BROKER_PORT}\" ",
          "   -e \"DOMAIN_PASSWORD=${DOMAIN_PASSWORD}\" ",
          "   -e \"PEER_ADDRESS=${PEER_ADDRESS}\" ",
          "   -e \"NODE_REGION=${NODE_REGION}\" ",
          "   -e \"ARG_apphost=${ARG_apphost}\" ",
          "   -e \"ELASTIC_HOST=${ELASTIC_HOST}\" ",
          "   -e \"ELASTIC_PORT=${ELASTIC_PORT}\" ",
          "   -e \"ELASTIC_INDEX=${ELASTIC_INDEX}\" ",
          "   -e \"POPULATE_NUODB=${POPULATE_NUODB}\" ",
          "   -v /local/production-archives:/opt/nuodb/var/opt/production-archives ",
          "   -p 48010:48010 ",
          "   -p 48004:48004 ",
          "   -p 48005:48005 ",
          "   ${NUODB_DOCKER} \n",

          "/opt/aws/bin/cfn-init ",
          "   --stack ${CFN_StackId} ",
          "   --resource NuoDBSMLaunchConfig ",
          "   --region ${CFN_Region} ",
          "   --configsets deploy_by_ansible\n",

          "# Signal results.\n",
          "/opt/aws/bin/cfn-signal -e $? ",
          "  --region ${CFN_Region} ",
          "  --stack \"${CFN_StackName}\" ",
          "  --resource NuoDBSMASG ",
          "  --reason \"CFN config setup exited with value $?.\" \n"
        ]]}}
      }
    },

    "NuoDBSMASG" : {
      "DependsOn" : "NuoDBBrokerASG",
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "CreationPolicy": { "ResourceSignal": { "Count" : "1", "Timeout": "PT45M" } },
      "UpdatePolicy" : {
        "AutoScalingRollingUpdate" : {
          "MinInstancesInService" : "1",
          "MaxBatchSize" : "1",
          "WaitOnResourceSignals" : "true",
          "SuspendProcesses" : [ "AlarmNotification" ],
          "PauseTime" : "PT45M"
        }
      },
      "Properties" : {
        "AvailabilityZones" : [ { "Fn::Select" : [ "0", { "Fn::GetAZs" : { "Ref" : "AWS::Region" } } ] } ],
        "VPCZoneIdentifier" : [ { "Fn::Select" : [ "0", { "Ref" : "SubnetIds" }]} ],
        "LaunchConfigurationName" : { "Ref" : "NuoDBSMLaunchConfig" },
        "MinSize" : "1",
        "MaxSize" : "2",
        "DesiredCapacity" : "1",
        "HealthCheckGracePeriod" : "600",
        "HealthCheckType" : "EC2",
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Join" : [ " - ", [ { "Ref": "AWS::StackName" }, "NuoDBSM" ]] },
            "PropagateAtLaunch" : "true"
          }
        ]
      }
    },

    "NuoDBTELaunchConfig": {
      "Type" : "AWS::AutoScaling::LaunchConfiguration",
      "Metadata" :
      {
        "AWS::CloudFormation::Init" : {

          "configSets" : {
            "deploy_by_ansible"    : [
              "setup_cloud_env",
              "setup_cloudwatch_logs",
              "install_cfn_hup",
              "setup_static_ip"
            ]
          },

          "setup_cloud_env" : {
            "files" : {
              "/local/etc/cloud-env.sh" :  {
                "content" : { "Fn::Join" : ["", [
                  "export NODE_REGION='",     { "Ref" : "AWS::Region" },  "'\n",
                  "export S3_Region='", { "Fn::FindInMap" : [ "S3Region", { "Ref" : "AWS::Region" },  "Region" ] },  "'\n",
                  "export CFN_StackId='",    { "Ref" : "AWS::StackId" }, "'\n",
                  "export DOMAIN_PASSWORD='", { "Ref": "DomainPassword" }, "'\n",
                  "export ENV_TYPE='", { "Ref": "EnvironmentType" }, "'\n",
                  "export AGENT_PORT=48004\n",
                  "export BROKER_PORT=48004\n",
                  "export NODE_PORT=48010\n",
                  "export NODE_TYPE='TE'\n",
                  "export PEER_ADDRESS='", { "Ref" : "peerAddress" }, "'\n",
                  "export DB_NAME='", { "Ref": "dbname" }, "'\n",
                  "export DB_USER='", { "Ref": "dbuser" }, "'\n",
                  "export DB_PASSWORD='", { "Ref": "dbpassword" }, "'\n",
                  "export ARG_apphost='", { "Fn::Join" : ["", ["http://", { "Ref" : "StorefrontElb" }, ":80/StorefrontWeb" ]]}, "'\n",
                  "export EcsClusterName='", { "Ref" : "EcsClusterName" }, "'\n",
                  "export NUODB_DOCKER='", { "Ref": "nuodbDocker" }, "'\n",
                  "export ELASTIC_HOST='", { "Ref" : "ElkPrivateIP"}, "'\n",
                  "export ELASTIC_PORT='", { "Ref" : "ElasticPort"}, "'\n",
                  "export ELASTIC_INDEX='", { "Ref" : "ElasticIndex"}, "'\n"

                ]]},
                "mode" : "000400",
                "owner" : "root",
                "group" : "root"
              }
            }
          },

          "setup_cloudwatch_logs" : {

            "files" : {
              "/etc/awslogs/awslogs.conf": {
                "content": { "Fn::Join": [ "", [
                  "[general]\n",
                  "state_file= /var/lib/awslogs/agent-state\n\n",

                  "[/var/log/messages]\n",
                  "file = /var/log/messages\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/messages\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/cloud-init]\n",
                  "file = /var/log/cloud-init.*\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/cloud-init.log\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/cloud-init-output]\n",
                  "file = /var/log/cloud-init-output.*\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/cloud-init-output.log\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/cfn-init]\n",
                  "file = /var/log/cfn-init.log*\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/cfn-init.log\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/cfn-init-cmd]\n",
                  "file = /var/log/cfn-init-cmd.log*\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb/{instance_id}/cfn-init-cmd.log\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/docker]\n",
                  "file = /var/log/docker\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb-docker/{instance_id}/docker-daemon\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n",

                  "[/var/log/docker-logs-output]\n",
                  "file = /var/log/docker-logs-output\n",
                  "log_group_name = ", { "Ref" : "CWLogGroup" }, "\n",
                  "log_stream_name = nuodb-docker/{instance_id}/docker-logs-output\n",
                  "#datetime_format = %Y-%m-%d %H:%M:%S,%f\n\n"

                ]]},
                "mode": "000400",
                "owner": "root",
                "group": "root"
              },
              "/etc/awslogs/awscli.conf": {
                "content": { "Fn::Join": [ "", [
                  "[plugins]\ncwlogs = cwlogs\n[default]\nregion = ", { "Ref" : "AWS::Region" }, "\n"
                ]]},
                "mode": "000400",
                "owner": "root",
                "group": "root"
              }
            },

            "packages" : {  "yum" : { "awslogs" : [] } },

            "services" : {
              "sysvinit" : {
                "awslogs" : {
                  "enabled" : "true",
                  "ensureRunning" : "true",
                  "files" : ["/etc/awslogs/awslogs.conf"]
                }
              }
            }
          },

          "install_cfn_hup" : {

            "files" : {
              "/etc/cfn/cfn-hup.conf" : {
                "content" : { "Fn::Join" : ["", [
                  "[main]\n",
                  "stack=", { "Ref" : "AWS::StackId" }, "\n",
                  "region=", { "Ref" : "AWS::Region" }, "\n",
                  "verbose=true\n",
                  "interval=5\n"
                ]]},
                "mode"    : "000400",
                "owner"   : "root",
                "group"   : "root"
              },

              "/etc/cfn/hooks.d/cfn-auto-reloader.conf" : {
                "content": { "Fn::Join" : ["", [
                  "[cfn-auto-reloader-hook]\n",
                  "triggers=post.update\n",
                  "path=Resources.NuoDBTELaunchConfig.Metadata.AWS::CloudFormation::Init\n",
                  "action=/opt/aws/bin/cfn-init -v ",
                  "         --stack ", { "Ref" : "AWS::StackName" },
                  "         --resource NuoDBTELaunchConfig ",
                  "         --configsets deploy_by_ansible ",
                  "         --region ", { "Ref" : "AWS::Region" }, "\n",
                  "runas=root\n"
                ]]}
              }
            },

            "services" : {
              "sysvinit" : {
                "cfn-hup" : {
                  "enabled" : "true",
                  "ensureRunning" : "true",
                  "files" : ["/etc/cfn/cfn-hup.conf", "/etc/cfn/hooks.d/cfn-auto-reloader.conf"]
                }
              }
            }
          },

          "setup_static_ip" : {
            "packages" : {
              "python": { "aws-ec2-assign-elastic-ip": [ "0.5.0" ] }
            },
            "commands" : {
              "01_assign_ip" : {
                "command" : "source /local/etc/cloud-env.sh && if [ ! -z $Whitelist_EIPS ]; then /usr/local/bin/aws-ec2-assign-elastic-ip --valid-ips ${Whitelist_EIPS} --region ${CFN_Region}; fi"
              }
            }
          }
        }
      },
      "Properties" : {
        "KeyName" : { "Ref" : "KeyName" },
        "AssociatePublicIpAddress" : "true",
        "ImageId" : { "Ref" : "NuoDBInstanceAMI" },
        "InstanceType"   : { "Ref" : "NuoDBInstanceType" },
        "IamInstanceProfile" : {"Ref": "EC2InstanceProfile" },
        "SecurityGroups" : [
          {"Ref" : "NuoDBSecurityGroup" }],
        "UserData" : { "Fn::Base64" : { "Fn::Join" : [ "", [
          "#!/bin/bash -v\n",
          "yum update -y aws-cfn-bootstrap\n",

          "export CFN_StackId=",     { "Ref" : "AWS::StackId" }, "\n",
          "export CFN_StackName=",   { "Ref" : "AWS::StackName" }, "\n",
          "export CFN_Region=",      { "Ref" : "AWS::Region"  }, "\n",
          "export NODE_REGION='",     { "Ref" : "AWS::Region" },  "'\n",
          "export S3_Region='", { "Fn::FindInMap" : [ "S3Region", { "Ref" : "AWS::Region" },  "Region" ] },  "'\n",

          "export DOMAIN_PASSWORD='", { "Ref": "DomainPassword" }, "'\n",
          "export ENV_TYPE='", { "Ref": "EnvironmentType" }, "'\n",
          "export AGENT_PORT=48004\n",
          "export BROKER_PORT=48004\n",
          "export NODE_PORT=48010\n",
          "export NODE_TYPE='TE'\n",
          "export PEER_ADDRESS='", { "Ref" : "peerAddress" }, "'\n",
          "export DB_NAME='", { "Ref": "dbname" }, "'\n",
          "export DB_USER='", { "Ref": "dbuser" }, "'\n",
          "export DB_PASSWORD='", { "Ref": "dbpassword" }, "'\n",
          "export ARG_apphost='", { "Fn::Join" : ["", ["http://", { "Ref" : "StorefrontElb" }, ":80/StorefrontWeb" ]]}, "'\n",
          "export EcsClusterName='", { "Ref" : "EcsClusterName" }, "'\n",
          "export NUODB_DOCKER='", { "Ref": "nuodbDocker" }, "'\n",
          "export INSTANCE_ID=$( /opt/aws/bin/ec2-metadata -i | cut -d ' ' -f 2 )\n",
          "export AZ=$( /opt/aws/bin/ec2-metadata -z | cut -d ' ' -f 2 )\n",
          "export ELASTIC_HOST='", { "Ref" : "ElkPrivateIP"}, "'\n",
          "export ELASTIC_PORT='", { "Ref" : "ElasticPort"}, "'\n",
          "export ELASTIC_INDEX='", { "Ref" : "ElasticIndex"}, "'\n",

          "VOL_ID=$( aws ec2 create-volume ",
          "  --region ${CFN_Region} --availability-zone ${AZ} ",
          "  --volume-type gp2 --size ", { "Ref" : "VolumeSize" }, " ${ENC_ARGS} ",
          " | grep VolumeId | cut -d \\\" -f 4 )\n",

          "aws ec2 create-tags --region ${CFN_Region}  --resources ${VOL_ID} --tags Key=Name,Value='",
          { "Fn::Join" : [ " - ", [ { "Ref": "AWS::StackName" }, "NuoDB Volume" ] ] } ,"'\n",

          "aws ec2 create-tags --region ${CFN_Region}  --resources ${VOL_ID} --tags Key=CustomerID,Value='",{ "Ref": "EcsClusterName" },"'\n",

          "sleep 10\n",
          "while ! [ \"available\" = $(aws ec2 describe-volumes --region ${CFN_Region} --volume-ids ${VOL_ID} --query Volumes[0].State | tr \\\" ' ' ) ]; do\n",
          "   sleep 1;\n",
          "done\n",

          "aws ec2 attach-volume --region ${CFN_Region}  ",
          "  --volume-id ${VOL_ID} --instance-id ${INSTANCE_ID} ",
          "  --device /dev/xvdf \n",

          "aws ec2 modify-instance-attribute --region ${CFN_Region} ",
          "  --instance-id $INSTANCE_ID --block-device-mappings ",
          "  '[{\"DeviceName\":\"/dev/xvdf\",\"Ebs\": {\"DeleteOnTermination\":true} }]'\n",

          "while ! [ -r /dev/xvdf ]; do sleep 1; done\n",
          "/sbin/mkfs.ext4 /dev/xvdf && mount /dev/xvdf /local\n",

          "aws ec2 describe-volumes --region ${CFN_Region} --volume-ids ${VOL_ID} \n",

          "mkdir -p /local/log\n",

          "yum install docker -y\n",

          "service docker restart\n",

          "cmd='$(aws ecr get-login --region us-east-1)' && eval $cmd && docker pull ${NUODB_DOCKER} \n",

          "docker run -d -e \"DOMAIN_PASSWORD=${DOMAIN_PASSWORD}\" ",
          "   -e \"AGENT_PORT=${AGENT_PORT}\" ",
          "   -e \"NODE_PORT=48010\" ",
          "   -e \"NODE_TYPE=${NODE_TYPE}\" ",
          "   -e \"ENV_TYPE=AWSEC2\" ",
          "   -e \"DB_NAME=${DB_NAME}\" ",
          "   -e \"DB_USER=${DB_USER}\" ",
          "   -e \"DB_PASSWORD=${DB_PASSWORD}\" ",
          "   -e \"BROKER_PORT=${BROKER_PORT}\" ",
          "   -e \"DOMAIN_PASSWORD=${DOMAIN_PASSWORD}\" ",
          "   -e \"PEER_ADDRESS=${PEER_ADDRESS}\" ",
          "   -e \"NODE_REGION=${NODE_REGION}\" ",
          "   -e \"ARG_apphost=${ARG_apphost}\" ",
          "   -e \"ELASTIC_HOST=${ELASTIC_HOST}\" ",
          "   -e \"ELASTIC_PORT=${ELASTIC_PORT}\" ",
          "   -e \"ELASTIC_INDEX=${ELASTIC_INDEX}\" ",
          "   -p 48010:48010 ",
          "   -p 48004:48004 ",
          "   -p 48005:48005 ",
          "   ${NUODB_DOCKER} \n",

          "/opt/aws/bin/cfn-init ",
          "   --stack ${CFN_StackId} ",
          "   --resource NuoDBTELaunchConfig ",
          "   --region ${CFN_Region} ",
          "   --configsets deploy_by_ansible\n",

          "# Signal results.\n",
          "/opt/aws/bin/cfn-signal -e $? ",
          "  --region ${CFN_Region} ",
          "  --stack \"${CFN_StackName}\" ",
          "  --resource NuoDBTEASG ",
          "  --reason \"CFN config setup exited with value $?.\" \n"
        ]]}}
      }
    },

    "NuoDBTEASG" : {
      "DependsOn" : "NuoDBSMASG",
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "CreationPolicy": { "ResourceSignal": { "Count" : "1", "Timeout": "PT45M" } },
      "UpdatePolicy" : {
        "AutoScalingRollingUpdate" : {
          "MinInstancesInService" : "1",
          "MaxBatchSize" : "1",
          "WaitOnResourceSignals" : "true",
          "SuspendProcesses" : [ "AlarmNotification" ],
          "PauseTime" : "PT45M"
        }
      },
      "Properties" : {
        "AvailabilityZones" : [ { "Fn::Select" : [ "0", { "Fn::GetAZs" : { "Ref" : "AWS::Region" } } ] } ],
        "VPCZoneIdentifier" : [ { "Fn::Select" : [ "0", { "Ref" : "SubnetIds" }]} ],
        "LaunchConfigurationName" : { "Ref" : "NuoDBTELaunchConfig" },
        "MinSize" : "1",
        "MaxSize" : "5",
        "DesiredCapacity" : "1",
        "HealthCheckGracePeriod" : "600",
        "HealthCheckType" : "EC2",
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Join" : [ " - ", [ { "Ref": "AWS::StackName" }, "NuoDBTE" ]] },
            "PropagateAtLaunch" : "true"
          }
        ]
      }
    }

  },
  "Outputs" : {
    "TeASG" : {
      "Description" : "TE Autoscaling group",
      "Value" : { "Ref" : "NuoDBTEASG"}
    }
  }
}